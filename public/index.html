<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cola.js test</title>
    <style>
        @import url(cola/style.css);

        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            fill: none;
            stroke: #000;
            stroke-width: 1.5px;
            opacity: 0.4;
            marker-end: url(#end-arrow);
        }

    </style>

</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.js"></script>
<script src="cola/cola.min.js"></script>
<script>
    var width = $(window).width() - 20,
        height = $(window).height() - 20

    var color = d3.scaleOrdinal([d3.schemeCategory20[1], d3.schemeCategory20[15]])
        .domain([false, true])

    var d3cola = cola.d3adaptor(d3)
        .avoidOverlaps(true)
        .size([width, height])

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)

    d3.json("graph.json", function (error, graph) {

        // Not sure I'm using explicit node.id for link indexing,
        // so need to force ids of nodes to match index in node array
        for (let node_idx in graph.nodes) {
            let node = graph.nodes[node_idx]
            if (+node_idx !== +node.id) {
                throw RangeError("graph.node index mismatch\n" +
                    `node with id ${node.id} is not number ${node_idx} in graph.nodes array`)
            }
        }

        graph.nodes.forEach(n => n.radius = node_radius(n))
        graph.nodes.forEach(n => n.height = n.width = 2 * n.radius)

        d3cola
            .nodes(graph.nodes)
            .links(graph.edges)
            .flowLayout("x", l => l.source.radius + l.target.radius + 20)
            .symmetricDiffLinkLengths(6)
            .start(10, 20, 20)

        // define arrow markers for graph links
        svg.append('svg:defs').append('svg:marker')
            .attr('id', 'end-arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 6)
            .attr('markerWidth', 3)
            .attr('markerHeight', 3)
            .attr('orient', 'auto')
            .append('svg:path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#000')

        var path = svg.selectAll(".link")
            .data(graph.edges)
            .enter().append('svg:path')
            .attr('class', 'link')

        var node = svg.selectAll(".node")
            .data(graph.nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr('id', n => n.id)
            .attr("r", n => n.radius)
            .style("fill", d => color(d.is_missing))
            .call(d3cola.drag)

        node.append("title")
            .text(d => d.repr)

        d3cola.on("tick", () => {
            path.each(d => {
                if (isIE()) this.parentNode.insertBefore(this, this)
            })
            // draw directed edges with proper padding from node centers
            path.attr('d', d => {
                var deltaX = d.target.x - d.source.x,
                    deltaY = d.target.y - d.source.y,
                    dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
                    normX = deltaX / dist,
                    normY = deltaY / dist,
                    sourcePadding = d.source.radius,
                    targetPadding = d.target.radius + 2,
                    sourceX = d.source.x + (sourcePadding * normX),
                    sourceY = d.source.y + (sourcePadding * normY),
                    targetX = d.target.x - (targetPadding * normX),
                    targetY = d.target.y - (targetPadding * normY)
                return `M${sourceX},${sourceY}L${targetX},${targetY}`
            })

            node.attr("cx", d => d.x)
                .attr("cy", d => d.y)
        })
    })

    function node_radius(node) {
        return Math.sqrt(node.repr.length) * 5
    }
    function isIE() {
        return ((navigator.appName == 'Microsoft Internet Explorer') || ((navigator.appName == 'Netscape') && (new RegExp("Trident/.*rv:([0-9]{1,}[\.0-9]{0,})").exec(navigator.userAgent) != null)))
    }
</script>


</body>
</html>
